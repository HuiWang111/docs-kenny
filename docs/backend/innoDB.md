---
# id: backend/innoDB
title: innoDB使用文档
tags:
  - innoDB
  - backend
---

# InnoDB存储引擎

### InnoDB文件系统
- redo logo 重做日志文件
  - lb_ibdata0
  - lb_ibdata01
  - 是一组文件，循环使用。文件大小不会增长
- 系统表空间
  - ibdata1
  - 包含：
    1. 数据字典
    2. 双写段
    3. 回滚段
    4. 修改换冲区
    5. 索引段
- 用户表空间
  - 每个表对应一个 `.ibd` 文件
  - 内容：
    1. 表中的数据
    2. 索引信息

### InnoDB逻辑结构
InnoDB存储引擎逻辑存储结构可分为五级：表空间、段、区、页、行

- 段
表空间由各个段组成，常见的段有数据段、索引段、回滚段。

- 区
一个区由64个连续的页组成，一个区的大小=1M=64页(16k)。

- 页
InnoDB每页默认大小是16k。也是InnoDB管理磁盘的最小单位，也是InnoDB中磁盘和内存交互的最小单位。

### InnoDB内存结构
- buffer poll
  - 数据页
    - LRU算法
  - 索引页
    - LRU算法
  - 修改缓冲区（插入缓冲区）
    - 提高更新辅助索引的性能
    - 把要插入的数据先存放在插入缓冲区。更新时把要更新的数据放到插入缓冲区（也叫更新缓冲区）。更新辅助索引的内容，攒到一定程度后批量更新。
  - 锁信息
  - 数据字典
  - 自适应hash索引
- 重做缓存区（redo log buffer）
  - 和磁盘上的重做日志（redo log）文件配合使用的
  - 重做日志是保证数据丢失的一个最重要环节
  - redo log符合WAL（write ahead log）标准
  - 用户表空间和系统表空间文件是随机写的（随机写性能差）
  - redo log是顺序写，性能优于随机写
  - 为了减少磁盘的io需要使用redo log buffer；事务没有提交之前先写缓冲区，事务提交之前把redo log buffer中的内容写入到磁盘；写入成功了事务就提交成功，如果写入失败了，事务就提交失败
- 内存数据落盘
  在数据提交之前修改内存缓冲区的数据页内容，导致内存中的数据页和磁盘上的数据页不一致；产生了脏页
  需要使用检查点（checkpoint）把脏页数据落盘：
  1. sharp checkpoint: 关闭数据库时使用强制落盘
  2. Fuzzy checkpoint: 数据库运行中落盘操作
    - 会以每秒或者每10秒一次的频率，将部分脏页从内存中刷新到磁盘，这个过程是异步的
    - 当LRU算法淘汰脏时需要执行checkpoint
  3. Dirty Page too much
    - innodb_max_dirty_pages_pct配置脏页数量的阈值，默认是75%
- 双写缓冲区
  - 当执行checkpoint之后，数据页需要落盘
  - 先把数据页放到双写缓冲区，然后写入系统表空间备份数据页，然后在写用户表空间。保证数据页有备份
